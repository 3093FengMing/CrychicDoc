name: Build VitePress, Pull Types, and Push to Private Repo

on:
  push:
    branches: [ main ]

jobs:
  pull-types:
    runs-on: self-hosted
    steps:
    - name: Checkout the code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Pull types from type repo
      env:
        TYPE_REPO_TOKEN: ${{ secrets.TYPE_REPO_TOKEN }}
      run: |
        git clone --depth 1 https://${TYPE_REPO_TOKEN}@github.com/M1hono/CrychicDocTypes.git type_repo
        cp -r type_repo/typefiles .
        rm -rf type_repo

  setup-and-build:
    runs-on: self-hosted
    needs: pull-types
    steps:
    - name: Checkout the code
      uses: actions/checkout@v4
      with: 
        fetch-depth: 0

    - name: Use correct Node.js version
      env:
        NODE_VERSION: 'v20.17.0'
      run: |
        export NODE_HOME="/usr/local/lib/nodejs/node-$NODE_VERSION"
        export PATH="$NODE_HOME/bin:$PATH"
        echo "Using Node.js version:"
        node --version

    - name: Install dependencies
      env:
        NODE_VERSION: 'v20.17.0'
      run: |
        export NODE_HOME="/usr/local/lib/nodejs/node-$NODE_VERSION"
        export PATH="$NODE_HOME/bin:$PATH"
        npm install

    - name: Build VitePress site
      env:
        NODE_VERSION: 'v20.17.0'
      run: |
        export NODE_HOME="/usr/local/lib/nodejs/node-$NODE_VERSION"
        export PATH="$NODE_HOME/bin:$PATH"
        npm run docs:build

  push-to-private-repo:
    runs-on: self-hosted
    needs: setup-and-build
    steps:
    - name: Clean up typefiles
      run: rm -rf typefiles

    - name: Push to private repo
      env:
        PRIVATE_REPO_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        NODE_VERSION: 'v20.17.0'
      run: |
        export NODE_HOME="/usr/local/lib/nodejs/node-$NODE_VERSION"
        export PATH="$NODE_HOME/bin:$PATH"
        cd .vitepress/dist
        git init
        git config user.name "GitHub Actions Bot"
        git config user.email "<>"

        git remote add origin https://${PRIVATE_REPO_TOKEN}@github.com/M1hono/CrychicDocSynchronization.git
        git fetch origin
        git add -A
        git commit -m "Update documentation" || echo "No changes to commit"
        git push --force origin main

        cd ../..
        rm -rf .vitepress/dist
